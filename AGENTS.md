> [!IMPORTANT]
> **Maintenance Rule for Codex**
> This `AGENT.md` file must stay synchronized with the codebase.
> Whenever the App is extended or refactored, Codex should:
> 1. Update the **links and line ranges** in `:codex-file-citation[...]` blocks to match current code.
> 2. Revise existing agent and flow descriptions to reflect any behavioral or architectural changes.
> 3. Add entries for **new agents, tools, or orchestrator modules** as they are introduced.
> 4. Remove or deprecate sections corresponding to deleted functionality.
> Treat this document as the **source of truth for the system’s active agent architecture.**
> Every Tier milestone (1–6) must include a brief update to `AGENT.md`.
> ---------------------------------------------------------------------------------------------

## Overview
This document describes how agents are defined and orchestrated in this repository.
This repo now centers on the Tier-1 orchestration layer under `app/`, `core/`, and
`tools/`. The legacy Rasa project has been archived under `legacy_rasa/` for
reference; it no longer participates in the active runtime.

New agents/tools should continue to prefer the `tools/` + `core/tool_registry.py` path, and
work should remain scoped to the active Tier unless the user explicitly agrees to
pull tasks forward.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=10 path=legacy_rasa/README.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/legacy_rasa/README.md#L1-L10"}​


The Tier-1 CLI assembles an `Orchestrator` with the rule-based `NLUService`, a `ToolRegistry`, the `LLMRouter`, and the Tier-2 `LearningLogger` so every message follows the NLU → Orchestrator → Tool chain and gets persisted for observability.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=39 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L22-L39"}​:codex-file-citation[codex-file-citation]{line_range_start=28 line_range_end=256 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L28-L256"}​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=199 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L199"}​

---

## Agent Flow
1. **User request** → handled by `core.orchestrator.Orchestrator.handle_message()` after the CLI captures the text.​:codex-file-citation[codex-file-citation]{line_range_start=41 line_range_end=60 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L41-L60"}​:codex-file-citation[codex-file-citation]{line_range_start=123 line_range_end=256 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L123-L256"}
   Tier‑5’s web API calls the new `handle_message_with_details()` (plus `run_tool()`) so each HTTP response includes the same extras/latency trace the CLI sees without duplicating business logic.​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=256 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L94-L256"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=180 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L1-L180"}​
2. **NLU classification + classifier fallback**: `NLUService.parse()` still leans on `core.command_parser.parse_command()` + `core.text_parsing` helpers for deterministic tool payloads, but when no rule fires it now asks the lazy-loaded `IntentClassifier` (log-reg TF‑IDF pipeline saved at `models/intent_classifier.pkl`) for a prediction and only promotes intents whose probability clears `CLASSIFIER_MIN_SCORE` before bothering the LLM router.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=100 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L13-L100"}​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=57 path=core/intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_classifier.py#L21-L57"}​:codex-file-citation[codex-file-citation]{line_range_start=28 line_range_end=55 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L28-L55"}​:codex-file-citation[codex-file-citation]{line_range_start=31 line_range_end=186 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L31-L186"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=360 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L1-L360"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=184 path=core/text_parsing.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/text_parsing.py#L1-L184"}​
3. **Router/Orchestrator**:
   - When the parsed intent meets the 0.65 confidence gate, `Orchestrator.handle_message()` maps the tool name (weather/news/todo_list/kitchen_tips/calendar_edit) to a registry entry and runs it immediately.​:codex-file-citation[codex-file-citation]{line_range_start=29 line_range_end=69 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L29-L69"}​:codex-file-citation[codex-file-citation]{line_range_start=146 line_range_end=205 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L146-L205"}​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=40 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L40"}​
   - Otherwise `LLMRouter.route()` decides whether any enabled tool (weather, news, todo_list, kitchen_tips, calendar_edit) should run; when no tool is selected the orchestrator triggers the “From ChatGPT” fallback.​:codex-file-citation[codex-file-citation]{line_range_start=177 line_range_end=220 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L177-L220"}​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L24-L121"}​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=49 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L21-L49"}​
   - Todo, calendar, kitchen, and app-guide prompts now run a shared “keyword probe” (`core/probes/tool_probes.py`) before committing to `list` or `find`. When matches exist the orchestrator rewrites the payload as `find` with inferred keywords; when no matches exist it either answers via the fallback LLM (for natural questions) or tags the pending intent with a `keyword_probe` flag explaining why it defaulted to `list`. Even when the classifier only returns `nlu_fallback`, the router now asks the LLM for a “tool hint”; if it nominates one of those CRUD tools, the probe path above runs before any generic “From ChatGPT” reply is emitted.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=120 path=core/probes/tool_probes.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/probes/tool_probes.py#L1-L120"}​:codex-file-citation[codex-file-citation]{line_range_start=74 line_range_end=360 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L74-L360"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=160 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L1-L160"}​:codex-file-citation[codex-file-citation]{line_range_start=600 line_range_end=1110 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L600-L1110"}​
4. **Tool execution** → weather/news still hit their APIs immediately, but CRUD intents now run in dry-run mode first: the orchestrator tags `extras.staged=True` and no JSON store is mutated until Tier-5 reviewers click the Self-Learning “Trigger” button, which posts to `/api/logs/label` and finally runs the tool with `dry_run=False` to persist the change.​:codex-file-citation[codex-file-citation]{line_range_start=87 line_range_end=230 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L87-L230"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=40 path=core/tooling/store_config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tooling/store_config.py#L1-L40"}​:codex-file-citation[codex-file-citation]{line_range_start=212 line_range_end=275 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L212-L275"}​:codex-file-citation[codex-file-citation]{line_range_start=70 line_range_end=90 path=web/static/index.html git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/index.html#L70-L90"}​
5. **Response assembly** → the orchestrator formatter map keeps weather/news/todo replies fully natural-language (todo now calls out priority + deadlines), while kitchen tips and calendar actions still echo the raw JSON payload for quick file-free verification when needed.​:codex-file-citation[codex-file-citation]{line_range_start=82 line_range_end=256 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L82-L256"}​:codex-file-citation[codex-file-citation]{line_range_start=118 line_range_end=200 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L118-L200"}​:codex-file-citation[codex-file-citation]{line_range_start=327 line_range_end=351 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L327-L351"}​:codex-file-citation[codex-file-citation]{line_range_start=393 line_range_end=449 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L393-L449"}​:codex-file-citation[codex-file-citation]{line_range_start=180 line_range_end=219 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L180-L219"}​:codex-file-citation[codex-file-citation]{line_range_start=335 line_range_end=360 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L335-L360"}​
6. **Turn logging & review queue** → every handled message produces a `TurnRecord`, and review-queue rows now carry a hashed `prompt_id` plus normalized parser payload so Tier‑5 can pre-fill correction forms without re-running NLU.​:codex-file-citation[codex-file-citation]{line_range_start=128 line_range_end=330 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L128-L330"}​:codex-file-citation[codex-file-citation]{line_range_start=114 line_range_end=199 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L114-L199"}​:codex-file-citation[codex-file-citation]{line_range_start=403 line_range_end=469 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L403-L469"}​ Tier‑5’s dashboard now snapshots the last 10 prompts (plus their eventual corrected payloads) via the shared `ConversationMemory`, surfaces them in a Related Prompts row, and stamps each field with a version tag so reviewers can tell what was auto-filled versus manually edited before triggering a tool.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=50 path=core/conversation_memory.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/conversation_memory.py#L1-L50"}​:codex-file-citation[codex-file-citation]{line_range_start=50 line_range_end=89 path=web/static/index.html git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/index.html#L50-L89"}​:codex-file-citation[codex-file-citation]{line_range_start=996 line_range_end=1090 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L996-L1090"}​
7. **Correction storage & training feed** → `/api/logs/label` accepts predicted vs corrected payloads, optionally runs the target tool to mutate data stores, appends a versioned record to `corrected_prompts.jsonl`, and returns `updated_stores` so the UI refreshes the right tabs; `/api/logs/corrected` pages through that history for the Training view.​:codex-file-citation[codex-file-citation]{line_range_start=192 line_range_end=327 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L192-L327"}​:codex-file-citation[codex-file-citation]{line_range_start=224 line_range_end=409 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L224-L409"}​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=128 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L128"}​

## Core Flows (key classes & functions)
| Flow | Key classes & functions | Entities / Notes |
| --- | --- | --- |
| **Weather & News (deterministic tools)** | `app.main.build_orchestrator()` wires the CLI so `NLUService`, `ToolRegistry`, and `LLMRouter` share state.​:codex-file-citation[codex-file-citation]{line_range_start=5 line_range_end=55 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L5-L55"}​ `core.nlu_service.NLUService.parse()` calls `core.command_parser.parse_command()` to extract `city`, `topic`, and `time` hints before `core.orchestrator.Orchestrator.handle_message()` dispatches `tools.weather_tool.run()` / `tools.news_tool.run()` and formatters.​:codex-file-citation[codex-file-citation]{line_range_start=39 line_range_end=90 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L39-L90"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=200 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L1-L200"}​:codex-file-citation[codex-file-citation]{line_range_start=117 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L117-L151"}​:codex-file-citation[codex-file-citation]{line_range_start=14 line_range_end=216 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L14-L216"}​:codex-file-citation[codex-file-citation]{line_range_start=26 line_range_end=350 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L26-L350"}​ | Weather flow sanitizes free-form city tokens, infers locations from the raw message, and defaults to Copenhagen when no city is provided while still honoring optional time hints; news flow normalizes prompts to topic-only queries before hitting NewsAPI/Google and responds with markdown links plus raw JSON payloads. |
| **Todo / Calendar CRUD** | Same deterministic parse; `core.orchestrator.Orchestrator._run_tool()` forwards parsed payloads to `tools.todo_list_tool.run()` and `tools.calendar_edit_tool.run()` for storage updates.​:codex-file-citation[codex-file-citation]{line_range_start=117 line_range_end=160 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L117-L160"}​:codex-file-citation[codex-file-citation]{line_range_start=260 line_range_end=520 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L260-L520"}​:codex-file-citation[codex-file-citation]{line_range_start=202 line_range_end=370 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L202-L370"}​ | Todo requests now sanitize natural-language prompts (“remind me…”, “add a todo from this form…”) into clean titles, infer deadlines + urgency keywords into `priority`, and reply with plain-language confirmations, while calendar flows accept Danish-style dates, list/delete/schedule synonyms, inferred time ranges/parts of day, and “at the office” locations before echoing raw JSON for verification.​:codex-file-citation[codex-file-citation]{line_range_start=332 line_range_end=520 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L332-L520"}​ The Tier-5 UI now presents a shared `id/title/content/keywords/link` grid for every CRUD action and forwards hidden `lookup_title` metadata so todo/calendar/kitchen/app‑guide updates can target entries even when reviewers only know the title, with the tools honoring that fallback when IDs are missing.​:codex-file-citation[codex-file-citation]{line_range_start=1005 line_range_end=1195 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L1005-L1195"}​:codex-file-citation[codex-file-citation]{line_range_start=352 line_range_end=444 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L352-L444"}​:codex-file-citation[codex-file-citation]{line_range_start=201 line_range_end=320 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L201-L320"}​:codex-file-citation[codex-file-citation]{line_range_start=248 line_range_end=340 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L248-L340"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=220 path=tools/app_guide_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/app_guide_tool.py#L1-L220"}​ |
| **Classifier fallback** | `core.intent_classifier.IntentClassifier.predict()` feeds `NLUService._classify()` when deterministic parsing fails, honoring `CLASSIFIER_MODEL_PATH` + `CLASSIFIER_MIN_SCORE` from `app.config`.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=58 path=core/intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_classifier.py#L21-L58"}​:codex-file-citation[codex-file-citation]{line_range_start=28 line_range_end=100 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L28-L100"}​:codex-file-citation[codex-file-citation]{line_range_start=31 line_range_end=186 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L31-L186"}​ | Classifier hits tag `extras.invocation_source="classifier"` plus `classifier_intent/confidence`, allowing logging + review scripts to audit decisions. |
| **Router fallback** | When no confident tool intent exists, `core.orchestrator.Orchestrator.handle_message()` asks `core.llm_router.LLMRouter.route()` for a tool or calls `general_answer()` for “From ChatGPT” responses, and any router-selected tool now receives the normalized parser payload (message, time hints, inferred cities, etc.) so fallback-triggered weather/news runs still have structured entities.​:codex-file-citation[codex-file-citation]{line_range_start=145 line_range_end=220 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L145-L220"}​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L24-L121"}​ | Router flow stamps `extras.invocation_source` as `router` or `fallback` and queues review items when the LLM has to answer without a tool. |
| **Self-learning corrections** | `core.parser_payloads.normalize_parser_payload()` keeps parser fields consistent, `core.data_views.rehydrate_labeled_prompts()` auto-moves legacy `labeled_prompts.jsonl` rows back into the pending queue, and `/api/logs/label` + `/api/logs/pending/{prompt_id}` capture fixes/cleanup with version history for the Tier‑5 dashboard.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/parser_payloads.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parser_payloads.py#L1-L41"}​:codex-file-citation[codex-file-citation]{line_range_start=224 line_range_end=409 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L224-L409"}​:codex-file-citation[codex-file-citation]{line_range_start=182 line_range_end=327 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L182-L327"}​ | `corrected_prompts.jsonl` stores `correction_id`, `version`, `predicted_payload`, `corrected_payload`, and `updated_stores`, letting the UI refresh the right tab after a correction and surfacing labeled pairs via `/api/logs/corrected`; migrating legacy labels resets the stats cards so pending counts reflect every prompt awaiting full payloads.​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=128 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L128"}​:codex-file-citation[codex-file-citation]{line_range_start=224 line_range_end=409 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L224-L409"}​:codex-file-citation[codex-file-citation]{line_range_start=192 line_range_end=327 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L192-L327"}​ The Pending Intent editor now includes chip-based Related Prompts and Intended Entities rows so reviewers can pull from the last ten user messages and live tool stores before submitting list/find/update/delete corrections.​:codex-file-citation[codex-file-citation]{line_range_start=70 line_range_end=102 path=web/static/index.html git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/index.html#L70-L102"}​:codex-file-citation[codex-file-citation]{line_range_start=735 line_range_end=1450 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L735-L1450"}​ These selections ride along with the correction payload, are normalized in `core.data_views.normalize_intended_entities()`, and persist through `/api/logs/pending`/`/api/logs/label` so the training bucket keeps both predicted and reviewer-tagged entity targets.​:codex-file-citation[codex-file-citation]{line_range_start=121 line_range_end=610 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L121-L610"}​:codex-file-citation[codex-file-citation]{line_range_start=224 line_range_end=287 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L224-L287"}​ The Related Prompts picker mirrors the entity search UX, limits suggestions to the ±5 user turns around the selected entry (combining `ConversationMemory` snapshots with any live chat prompts), falls back to neighboring pending records when older tickets lack history, and automatically closes whenever the Intended Entities dropdown opens so the overlays never collide; when a card is triggered, any pending prompts whose text was added as a related entry vanish from the queue immediately across the CLI and backend so multi-turn tickets disappear together.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=60 path=core/conversation_memory.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/conversation_memory.py#L1-L60"}​:codex-file-citation[codex-file-citation]{line_range_start=1250 line_range_end=1450 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L1250-L1450"}​:codex-file-citation[codex-file-citation]{line_range_start=225 line_range_end=280 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L225-L280"}​ Pending cards also inherit asserted entities straight from the keyword probe: find/list intents prefill the Intended Entities chips, while single-entity update/delete flows automatically drop the probe’s best match into the Title/ID fields so reviewers only tweak mistaken cases.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=220 path=core/probes/tool_probes.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/probes/tool_probes.py#L1-L220"}​:codex-file-citation[codex-file-citation]{line_range_start=2100 line_range_end=2360 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L2100-L2360"}​ |

---

## Agents
| Agent | Description | Source | Trigger / Intent |
|--------|--------------|--------|------------------|
| **NLU Agent** | Delegates all user prompts to the shared command parser so each tool intent is detected with structured entities before the LLM router is considered. | `core/nlu_service.py` (`NLUService`)​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=69 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L13-L69"}​ | All user inputs |
| **Intent Classifier** | Lazy-loads the scikit-learn TF‑IDF + LogisticRegression pipeline from `models/intent_classifier.pkl`, returns predicted intent + probability, and adds classifier metadata to every turn for drift monitoring. | `core/intent_classifier.py`, `app/train_intent_classifier.py`​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=58 path=core/intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_classifier.py#L21-L58"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=212 path=app/train_intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/train_intent_classifier.py#L1-L212"}​ | Triggered when `parse_command` returns `None` and the classifier confidence meets `CLASSIFIER_MIN_SCORE`; the resulting intent is treated like any deterministic match.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=100 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L13-L100"}​:codex-file-citation[codex-file-citation]{line_range_start=31 line_range_end=186 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L31-L186"}​ |
| **Weather Agent** | Calls Open-Meteo geocoding + hourly/current APIs, sanitizes noisy city tokens, infers locations straight from the user prompt, defaults to Copenhagen when no city survives parsing, honors parsed time hints for future hours, and now phrases replies like “Weather in Copenhagen tomorrow…” so reviewers immediately see which time slice was inferred. | `tools/weather_tool.py` (`run`, `format_weather_response`)​:codex-file-citation[codex-file-citation]{line_range_start=14 line_range_end=220 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L14-L220"}​ | `intent:weather` (produced directly by the command parser).​:codex-file-citation[codex-file-citation]{line_range_start=29 line_range_end=69 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L29-L69"}​ |
| **News Agent** | Normalizes natural-language prompts down to just the requested topic before querying Google News/NewsAPI, filters out noisy sources, and emits markdown-linked headlines plus the raw JSON payload. | `tools/news_tool.py` (`run`, `format_news_list`)​:codex-file-citation[codex-file-citation]{line_range_start=26 line_range_end=350 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L26-L350"}​ | `intent:news` (command parser output).​:codex-file-citation[codex-file-citation]{line_range_start=29 line_range_end=69 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L29-L69"}​ |
| **Todo Agent** | Maintains JSON-backed todos with CRUD actions, Danish deadline parsing, countdown metadata, keyword-based `find` searches, and now auto-sanitizes natural-language prompts into clean titles, captures urgency keywords into `priority`, enforces deadlines on every create, and emits concise confirmations without appending raw JSON. | `tools/todo_list_tool.py` (`run`, `format_todo_response`)​:codex-file-citation[codex-file-citation]{line_range_start=260 line_range_end=520 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L260-L520"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=210 path=tests/testing_tools/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_todo_list_tool.py#L1-L210"}​ | Command-parser intent `todo_list` resolves inside `NLUService.parse()` so deterministic cases run before router escalation; list/find/delete cues (e.g., “find the todo about milk”) are parsed explicitly alongside completion/update phrases.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=200 path=core/parsers/todo.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parsers/todo.py#L1-L200"}​ |
| **Kitchen Tips Agent** | Provides CRUD flows backed by the JSON tip store; entries now persist `content`, normalized `keywords`, and optional `link`, and `find/update/delete` accept either IDs or the lookup title so the reviewer UI’s five standard actions remain in sync with the backend. | `tools/kitchen_tips_tool.py` (`run`, `format_kitchen_tips_response`)​:codex-file-citation[codex-file-citation]{line_range_start=27 line_range_end=330 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L27-L330"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=tests/testing_tools/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_kitchen_tips_tool.py#L1-L140"}​ | Command-parser intent `kitchen_tips` collapses “search”/“get” phrases into `find` before the orchestrator runs.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=130 path=core/parsers/kitchen.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parsers/kitchen.py#L1-L130"}​ |
| **Calendar Edit Agent** | Adds, updates, and deletes calendar events while accepting Danish-style `dd/mm/yyyy` timestamps, verb aliases from the parser (“schedule…”, “set up…”, “delete the meeting…”), inferred locations (“at the office”), and part-of-day/range hints before persisting the ISO-normalized store + raw formatter payload; missing start times now default to “now” and lone end-times inherit the start date so pending-labeling fields stay prefilled. | `tools/calendar_edit_tool.py` (`run`, `format_calendar_response`)​:codex-file-citation[codex-file-citation]{line_range_start=202 line_range_end=404 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L202-L404"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=120 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L120"}​ | Command-parser intent `calendar_edit` now maps create/list/update/delete from conversational phrases, infers time ranges (15:00–16:00), parts of day (“Wednesday afternoon”), “at the office” locations, and injects default/fallback datetimes for missing fields before the tool runs.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=260 path=core/parsers/calendar.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parsers/calendar.py#L1-L260"}​ |
| **App Guide Knowledge Agent** | File-backed knowledge sections with ISO timestamps plus a tool/CLI surface that exposes the standard five verbs; entries now persist `keywords` + optional `link`, and `find/update/delete` can resolve either a section ID or the lookup title so reviewers can work without memorizing slugs. | `knowledge/app_guide.py`, `tools/app_guide_tool.py`​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=185 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L185"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=220 path=tools/app_guide_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/app_guide_tool.py#L1-L220"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=110 path=tests/testing_tools/test_app_guide_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_app_guide_tool.py#L1-L110"}​ | Parser phrases like “get/search/upsert” are normalized to those actions before the orchestrator runs.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=150 path=core/parsers/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parsers/app_guide.py#L1-L150"}​ |
| **Fallback Agent** | Asks OpenAI which tool should run and, when none apply, produces a prefixed “From ChatGPT” answer for the user. | `core/llm_router.py` (`LLMRouter`)​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L24-L121"}​ | Low NLU confidence / router “no tool” decisions.​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L94-L151"}​ |
| **Learning Logger** | Persists `TurnRecord`/`ReviewItem` JSONL rows with configurable redaction (email/phone/credit card/gov ID/URL) and file rotation for analytics and future Tier-4 retraining workflows. | `core/learning_logger.py` (`LearningLogger`, `TurnRecord`, `ReviewItem`)​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​ | All handled turns; review queue populated for low-confidence, fallback, or tool errors.​:codex-file-citation[codex-file-citation]{line_range_start=133 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L133-L203"}​ |

---

## Key Files
| File | Purpose |
|------|----------|
| `app/main.py` | CLI entry point; builds the orchestrator wiring NLU, registry, router, and Tier-2 logger.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=39 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L21-L39"}​ |
| `app/web_api.py` | FastAPI server that exposes `/api/chat`, log/label endpoints, and mounts the Tier-5 static dashboard assets.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=278 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L1-L278"}​ |
| `app/config.py` | Defaults for NLU threshold, logging paths (`LOGGING_ENABLED`, `LOG_DIR`, `REVIEW_QUEUE_DIR`), redaction controls (`LOG_REDACTION_ENABLED`, `LOG_REDACTION_PATTERNS`), rotation settings (`LOG_MAX_BYTES`, `LOG_BACKUP_COUNT`), enabled tools, OpenAI credentials, and Tier-5 web toggles (`WEB_UI_ENABLED`, `WEB_UI_HOST`, `WEB_UI_PORT`).​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=220 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L220"}​ |
| `core/orchestrator.py` | Coordinates NLU, tool dispatch, logging, and response formatting.​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=220 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L32-L220"}​ |
| `core/nlu_service.py` | Lightweight intent detector that delegates every utterance to the shared command parser before considering any LLM fallback.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=69 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L13-L69"}​ |
| `core/llm_router.py` | OpenAI-based fallback router that decides between tools, instructs on missing credentials, and returns direct replies.​:codex-file-citation[codex-file-citation]{line_range_start=15 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L15-L121"}​ |
| `core/tool_registry.py` | Registers tool callables and mediates execution/lookup.​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=40 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L40"}​ |
| `core/command_parser.py` | Deterministic parser that extracts weather/news/todo/kitchen/calendar intents plus structured titles, notes, and Danish dates from free-form prompts.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=360 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L1-L360"}​ |
| `core/text_parsing.py` | Shared helpers for Danish/relative date parsing plus quoted title/note extraction reused by todos, calendar, and kitchen tips.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=184 path=core/text_parsing.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/text_parsing.py#L1-L184"}​ |
| `core/parser_payloads.py` | Canonicalizes parser payload keys (start/end/deadline/location/etc.) before they are logged or saved so correction records share the same schema across tools.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/parser_payloads.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/parser_payloads.py#L1-L41"}​ |
| `core/data_views.py` | JSONL iterators plus export/import helpers shared by the admin CLI and the Tier-5 API (pending queue slices, label dedupe, classifier reviews, correction history w/ versioning + pagination).​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=409 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L1-L409"}​ |
| `core/learning_logger.py` | Dataclass schemas (`TurnRecord`, `ReviewItem`), JSONL writer, configurable redaction, and size-based log rotation used for Tier-2 observability.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​ |
| `tools/weather_tool.py` | Weather tool implementation plus time-aware formatter helpers.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=248 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L13-L248"}​ |
| `tools/news_tool.py` | News tool implementation plus formatter helpers.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=315 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L1-L315"}​ |
| `core/json_storage.py` | Shared Tier-3 helper providing atomic JSON reads/writes for every new tool store.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​ |
| `knowledge/app_guide.py` / `tools/app_guide_tool.py` | Editable knowledge base plus the tool wrapper that now routes everything through list/find/create/update/delete with duplicate protection on `create` and partial updates on `update`.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=220 path=tools/app_guide_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/app_guide_tool.py#L1-L220"}​ |
| `app/admin_scripts.py` | Tier-4 admin CLI: dump pending prompts into intent-grouped CSV/JSON batches, append reviewer labels into `labeled_prompts.jsonl`, and surface classifier-driven mistakes via `review-classifier`.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=80 path=app/admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/admin_scripts.py#L1-L80"}​ |
| `config/intents.yml` | Canonical intent/tool definitions shared by parser, classifier, and admin scripts.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=22 path=config/intents.yml git_url="https://github.com/cbmluca/rasa-llm/blob/main/config/intents.yml#L1-L22"}​ |
| `core/intent_config.py` | YAML/JSON loader that validates supported intents and exposes lookups for tooling + training.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=102 path=core/intent_config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_config.py#L1-L102"}​ |
| `core/intent_classifier.py` | Lazy loader returning classifier predictions (intent + probability) from the serialized scikit-learn pipeline.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=58 path=core/intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_classifier.py#L21-L58"}​ |
| `app/train_intent_classifier.py` | Training CLI that ingests labeled prompts, fits TF‑IDF LogisticRegression, and writes `models/intent_classifier.pkl` + `reports/intent_classifier.json`.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=212 path=app/train_intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/train_intent_classifier.py#L1-L212"}​ |
| `tools/todo_list_tool.py` | Todo tool with CRUD operations, formatter helpers, Danish deadlines, and countdown metadata.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=420 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L1-L420"}​ |
| `tools/kitchen_tips_tool.py` | Kitchen tips CRUD implementation where `find` unifies keyword searches and direct ID/title lookups, keeping responses aligned with the five standard actions.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=330 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L1-L330"}​ |
| `tools/calendar_edit_tool.py` | Calendar editing tool with ISO validation, run/update/delete paths, and summary formatter.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=402 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L1-L402"}​ |
| `docs/knowledge.md` | Human-readable knowledge playbook that now mirrors the AppGuide content and lives alongside the JSON-backed knowledge base.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=54 path=docs/knowledge.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/docs/knowledge.md#L1-L54"}​ |
| `tools/__init__.py` | Loads weather, news, todo, kitchen, and calendar tools into the shared registry.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=20 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L1-L20"}​ |
| `web/static/` | Tier-5 UI assets: `index.html` now stacks Chat + Self-Learning Dashboard + tabbed data stores before the Training views, `app.js` renders the dynamic correction form/polling/state, forces the calendar tool into a fixed 4-column grid, keeps optional end-date/time inputs empty until edited (no placeholders), only focuses inputs when clicked directly, normalizes every non-weather/news intent to the five core actions, and canonicalizes parser payloads into the shared `id/title/content/keywords/link` grid while attaching hidden lookup metadata; `styles.css` pins those grid coordinates (Title/Start/End/Link over ID/Times/Location with a full-width Notes row).​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=284 path=web/static/index.html git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/index.html#L1-L284"}​:codex-file-citation[codex-file-citation]{line_range_start=1005 line_range_end=1195 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L1005-L1195"}​:codex-file-citation[codex-file-citation]{line_range_start=761 line_range_end=813 path=web/static/styles.css git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/styles.css#L761-L813"}​ |
| `tests/` | Pytest suite that must grow alongside new features (Tier‑2 logging, Tier‑3 tools, Tier‑4 admin flows, and Tier‑5 API/UI wiring).:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=86 path=tests/test_learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_learning_logger.py#L1-L86"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=40 path=tests/test_news_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_news_service.py#L1-L40"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=90 path=tests/test_nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_nlu_service.py#L1-L90"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=80 path=tests/testing_tools/test_app_guide_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_app_guide_tool.py#L1-L80"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=166 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L1-L166"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=85 path=tests/testing_tools/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_kitchen_tips_tool.py#L1-L85"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=100 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L100"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=30 path=tests/test_command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_command_parser.py#L1-L30"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=105 path=tests/test_admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_admin_scripts.py#L1-L105"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=71 path=tests/test_intent_classifier_training.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_intent_classifier_training.py#L1-L71"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=55 path=tests/test_classifier_integration.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_classifier_integration.py#L1-L55"}:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=142 path=tests/test_web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_web_api.py#L1-L142"} |

---

### Archived Legacy Rasa Project
The historical Rasa project structure is preserved under `legacy_rasa/` for
reference only. Move those files back to their original locations if you ever
need to resurrect the old stack.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=10 path=legacy_rasa/README.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/legacy_rasa/README.md#L1-L10"}​

---

## Notes
- Confidence threshold for NLU fallback: `0.65` (see `app/config.py`).​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=38 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L38"}​
- Classifier defaults: `CLASSIFIER_MODEL_PATH` points at `models/intent_classifier.pkl` and `CLASSIFIER_MIN_SCORE` gates runtime predictions; override via env vars if a new model is deployed.​:codex-file-citation[codex-file-citation]{line_range_start=31 line_range_end=186 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L31-L186"}​ 
- The Tier-1 CLI automatically loads `.env` values on import when `python-dotenv` is installed.​:codex-file-citation[codex-file-citation]{line_range_start=8 line_range_end=13 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L8-L13"}​
- Logging defaults: `LOGGING_ENABLED` (on by default), `LOG_DIR` (`logs/turns.jsonl`), and `REVIEW_QUEUE_DIR` (`data_pipeline/nlu_training_bucket/pending.jsonl`) auto-create directories when the logger writes.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=105 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L22-L105"}​:codex-file-citation[codex-file-citation]{line_range_start=184 line_range_end=195 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L184-L195"}​
- Redaction is enabled by default; tune `LOG_REDACTION_ENABLED` / `LOG_REDACTION_PATTERNS` for raw transcripts or custom scrubbing (emails, phones, credit cards, gov IDs, URLs).​:codex-file-citation[codex-file-citation]{line_range_start=108 line_range_end=135 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L108-L135"}​:codex-file-citation[codex-file-citation]{line_range_start=211 line_range_end=227 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L211-L227"}​
- `docs/knowledge.md` is part of the Tier‑3 knowledge base; keep its runbook in lock-step with `knowledge/app_guide.py` entries so the human-readable guide matches the JSON exposed to agents.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=54 path=docs/knowledge.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/docs/knowledge.md#L1-L54"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​
- Todo reminders parse Danish-formatted dates (e.g., `1/7/2026`, `1 juli 2026`) from structured fields or free-form text, attach `deadline_days_until`, and order `list` results with closest deadlines first followed by alphabetical leftovers.​:codex-file-citation[codex-file-citation]{line_range_start=43 line_range_end=260 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L43-L260"}​:codex-file-citation[codex-file-citation]{line_range_start=34 line_range_end=106 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L34-L106"}​
- Size-based rotation is governed by `LOG_MAX_BYTES` and `LOG_BACKUP_COUNT`; older segments spill into `.1`, `.2`, etc., before new turns append.​:codex-file-citation[codex-file-citation]{line_range_start=137 line_range_end=162 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L137-L162"}​:codex-file-citation[codex-file-citation]{line_range_start=229 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L229-L253"}​
- Kitchen tips and calendar formatters still include the raw JSON payload after the friendly sentence for file-free verification, while the todo formatter now returns natural-language responses with optional priority/deadline callouts only.​:codex-file-citation[codex-file-citation]{line_range_start=180 line_range_end=219 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L180-L219"}​:codex-file-citation[codex-file-citation]{line_range_start=335 line_range_end=360 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L335-L360"}​:codex-file-citation[codex-file-citation]{line_range_start=393 line_range_end=449 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L393-L449"}​
- Parser enhancements keep kitchen/app-guide intents aligned with natural phrasing: “share a kitchen tip about…”, “add a kitchen tip via the form…”, “what App Guide sections do we have?”, and “update the App Guide entry for tier_policies…” all resolve to the appropriate actions before the router sees them.​:codex-file-citation[codex-file-citation]{line_range_start=200 line_range_end=360 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L200-L360"}​

- Todo parser improvements: detector now recognizes list/complete/“remind me” styles, promotes implicit completion requests to `action=update` with `status=completed`, and strips noisy prefixes from inferred titles before the tool sees them.​:codex-file-citation[codex-file-citation]{line_range_start=171 line_range_end=260 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L171-L260"}​
- Tool agents expose `run(payload)` callables; formatters convert their dict results into strings for replies.​:codex-file-citation[codex-file-citation]{line_range_start=65 line_range_end=145 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L65-L145"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=315 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L1-L315"}​
- Prompt labeling workflow: use `python -m app.admin_scripts export-prompts --dedupe` to generate per-intent CSV/JSON batches, annotate `reviewer_intent`, then run `python -m app.admin_scripts import-labels --dedupe` so `data_pipeline/nlu_training_bucket/labeled_prompts.jsonl` stays clean.​:codex-file-citation[codex-file-citation]{line_range_start=28 line_range_end=57 path=app/admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/admin_scripts.py#L28-L57"}​
- Classifier audits: `python -m app.admin_scripts review-classifier --intent todo_list --limit 20` inspects `logs/turns.jsonl` for classifier-sourced turns where tools failed or reviewer labels disagreed, so drift is visible before retraining.​:codex-file-citation[codex-file-citation]{line_range_start=58 line_range_end=74 path=app/admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/admin_scripts.py#L58-L74"}​
- Tier‑3 todo/kitchen/calendar tools share `core.json_storage` for atomic persistence and store their data under `data_pipeline/*.json`, keeping the formatters deterministic for the router.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​:codex-file-citation[codex-file-citation]{line_range_start=137 line_range_end=260 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L137-L260"}​:codex-file-citation[codex-file-citation]{line_range_start=82 line_range_end=170 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L82-L219"}​:codex-file-citation[codex-file-citation]{line_range_start=142 line_range_end=300 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L142-L360"}​
- Turn logs now persist `resolved_intent` and `resolved_tool` inside the `extras` blob so future NLU training data captures which deterministic parser/tool handled each utterance.​:codex-file-citation[codex-file-citation]{line_range_start=93 line_range_end=205 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L93-L205"}​
- Weather tool now sanitizes city tokens, infers locations (with Copenhagen as the default fallback), and then selects the closest hourly forecast or current conditions with the appropriate note.​:codex-file-citation[codex-file-citation]{line_range_start=110 line_range_end=216 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L110-L216"}​
- News tool keeps the embedded NewsAPI/Google RSS helpers, but additionally normalizes prompts down to the topic phrase and formats each headline as a markdown link for the UI/CLI.​:codex-file-citation[codex-file-citation]{line_range_start=26 line_range_end=350 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L26-L350"}​
- When the router cannot pick a tool, the general ChatGPT fallback answers the user and prefixes responses with “From ChatGPT.”​:codex-file-citation[codex-file-citation]{line_range_start=121 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L121-L151"}​:codex-file-citation[codex-file-citation]{line_range_start=79 line_range_end=92 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L79-L92"}​
- LLM fallback uses the OpenAI Python v1 client (`chat.completions`) and, when credentials are missing, returns guidance for setting `OPENAI_API_KEY` before retrying.​:codex-file-citation[codex-file-citation]{line_range_start=58 line_range_end=92 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L58-L92"}​:codex-file-citation[codex-file-citation]{line_range_start=8 line_range_end=54 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L8-L54"}​
- Each new Tier deliverable must include pytest coverage and the command/output should be surfaced in status updates so reviewers see the prompts/results.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=40 path=tests/test_news_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_news_service.py#L1-L40"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=31 path=tests/test_nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_nlu_service.py#L1-L31"}​
- Tier progression is linear: do not start higher-tier features without explicit user approval to pull them forward.​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=115 path=AGENTS.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/AGENTS.md#L94-L115"}​
- `app/admin_scripts.py review_pending_prompts` lists recent failed utterances so Tier-3 reviewers can tag data before Tier-4 learning work begins.​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=52 path=app/admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/admin_scripts.py#L24-L52"}​
- Future agents can be added by:
  1. Creating a new tool module under `/tools/` that implements a `run(payload)` callable.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=116 path=tools/weather_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather_tool.py#L13-L116"}​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=25 path=tools/news_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news_tool.py#L11-L25"}​
  2. Registering it via `load_all_core_tools()` or analogous registry wiring in `tools/__init__.py`.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=16 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L13-L16"}​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=36 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L36"}​
  3. Updating orchestrator or router configuration (e.g., enabling the tool name in `app/config.py`) and reflecting it in this Agents table.

## Architecture Guidelines
- **Parser-first NLU:** Extend `core.command_parser` whenever we add intents so every tool benefits before the router/LLM path is considered.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=360 path=core/command_parser.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/command_parser.py#L1-L360"}​
- **Object-oriented stores:** Keep persistence/logic inside store classes (`TodoStore`, `CalendarStore`, etc.) and expose simple `run(payload)` wrappers for the orchestrator.​:codex-file-citation[codex-file-citation]{line_range_start=43 line_range_end=420 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L43-L420"}​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=360 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L32-L360"}​
- **Reusable helpers:** Shared parsing/persistence logic belongs in `core/text_parsing.py` and `core/json_storage.py`; reference those modules when documenting new flows.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=184 path=core/text_parsing.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/text_parsing.py#L1-L184"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​
- **Centralized registration:** Load tools through `tools.load_all_core_tools()` so the orchestrator and router reference the same registry.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=20 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L13-L20"}​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=40 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L40"}​
- **Prompt quality gate:** After any sizeable NLU/router update, run `./start eval --config config/eval_prompts.yml` (or auto mode) before merging so regressions are caught early.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=220 path=app/eval_suite.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/eval_suite.py#L1-L220"}

---

## Development Roadmap (Tier Plan)
Each Tier represents a functional milestone in the system’s evolution.
Codex must keep this section synchronized with the repository state.
Whenever a Tier is completed or partially implemented, update this table and associated code citations.

| Tier  | Title                                                   | Purpose                                                                    | Core Files / Modules                                                                                                                             | Key Additions                                                                                          |
| ----- | ------------------------------------------------------- | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------ |
| **1** | **Core Runtime + 2 Tools (Baseline)**                   | Establish CLI orchestrator pipeline (NLU → LLM → Tool) with weather/news.  | `app/main.py`, `core/orchestrator.py`, `core/nlu_service.py`, `core/llm_router.py`, `core/tool_registry.py`, `tools/weather_tool.py`, `tools/news_tool.py` | Working message loop, formatted responses.                                                             |
| **2** | **Logging & Observability**                             | Add minimal analytics and failure visibility before scaling tools.         | `core/learning_logger.py`, `core/orchestrator.py`, `app/config.py`, `tests/test_learning_logger.py`                                              | `LearningLogger` now captures every turn + review queue entries, redacts emails/phones/cards/IDs/URLs by default, rotates log files with size caps, and ships with config toggles/env overrides plus pytest coverage validating JSONL output, rotation, and review triggers.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​:codex-file-citation[codex-file-citation]{line_range_start=56 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L56-L203"}​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=162 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L162"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=164 path=tests/test_learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_learning_logger.py#L1-L164"}​ |
| **3** | **Tool Expansion + Editable Knowledge Base (RAG Seed)** | Broaden functionality and introduce persistent, editable data.             | `tools/todo_list_tool.py`, `tools/kitchen_tips_tool.py`, `tools/calendar_edit_tool.py`, `knowledge/app_guide.py`, `core/json_storage.py`, `tools/__init__.py`, Tier‑3 pytest modules | JSON-backed todo/kitchen/calendar tools with shared atomic storage + formatter outputs, editable `AppGuideStore`, router/config updates to expose the new tool names, and pytest coverage for every store.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=402 path=tools/calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit_tool.py#L1-L402"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=420 path=tools/todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list_tool.py#L1-L420"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=330 path=tools/kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips_tool.py#L1-L330"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=20 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L1-L20"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range end=83 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L83"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range end=155 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L1-L155"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range end=120 path=tests/testing_tools/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/testing_tools/test_kitchen_tips_tool.py#L1-L120"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range end=66 path=tests/test_app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_app_guide.py#L1-L66"}​ |
| **4** | **Self-Evolving Logic**                                 | Use logs + admin tooling to curate data, train a lightweight classifier, and feed confident predictions back into Tier‑1. | `config/intents.yml`, `core/intent_config.py`, `app/admin_scripts.py`, `app/train_intent_classifier.py`, `core/intent_classifier.py`, `tests/test_admin_scripts.py`, `tests/test_intent_classifier_training.py`, `tests/test_classifier_integration.py`​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=22 path=config/intents.yml git_url="https://github.com/cbmluca/rasa-llm/blob/main/config/intents.yml#L1-L22"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=80 path=app/admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/admin_scripts.py#L1-L80"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=212 path=app/train_intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/train_intent_classifier.py#L1-L212"}​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=58 path=core/intent_classifier.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/intent_classifier.py#L21-L58"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=105 path=tests/test_admin_scripts.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_admin_scripts.py#L1-L105"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=71 path=tests/test_intent_classifier_training.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_intent_classifier_training.py#L1-L71"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=55 path=tests/test_classifier_integration.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_classifier_integration.py#L1-L55"}​ | Prompt export/dedupe/import scripts, labeled JSONL store, TF‑IDF LogisticRegression trainer with drift reports, runtime classifier hook in `NLUService`, and pytest coverage for labeling + classifier flows so confident predictions fire tools before the router. |
| **5** | **Web UI / Admin Panel**                                | FastAPI API + single-page dashboard: chat console, Self-Learning editor (predicted vs corrected payloads, version history, Latest Confirmed), tabbed data stores, classifier + corrected pairs, export/import. | `app/web_api.py`, `core/data_views.py`, `web/static/index.html`, `web/static/app.js`, `tests/test_web_api.py`​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=327 path=app/web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/web_api.py#L1-L327"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=409 path=core/data_views.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/data_views.py#L1-L409"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=284 path=web/static/index.html git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/index.html#L1-L284"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=1195 path=web/static/app.js git_url="https://github.com/cbmluca/rasa-llm/blob/main/web/static/app.js#L1-L1195"}​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=142 path=tests/test_web_api.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_web_api.py#L1-L142"}​ | Chat console backed by `/api/chat`, dynamic labeling form that POSTs `/api/logs/label` (with store refresh hooks), classifier findings, corrected prompt table, and todo/kitchen/calendar/app-guide CRUD that call the existing tool handlers. |
| **6** | **Security & Data Governance**                          | Formalize auth, privacy, and data-retention controls before expanding UI reach. | `app/security.py`, `docs/security.md`, policy configs                                                                                           | Auth for the Web UI, prompt-log retention policies, PII redaction reviews, and network hardening TODOs. |
| **7** | **Infrastructure / Always-On Execution**                | Enable persistent runtime and scheduled background tasks.                  | `app/main.py` (scheduler hooks), deployment configs                                                                                              | Cron/APScheduler or equivalent for continuous operation.                                               |
| **8** | **Scheduler & Agent Actions (Advanced Calendar)**       | Allow delayed or autonomous actions such as reminders and pseudo-bookings. | `core/scheduler.py`, `tools/calendar_edit_tool.py` (extended), `data_pipeline/calendar_tasks.json`                                                    | Handle time-based triggers: “book badminton Thursday,” “doctor check-up window.”                       |

**Evolution Summary**
- Tiers 1–2: foundation and visibility.
- Tier 3: breadth (more tools + editable data).
- Tier 4: self-learning (turn logs → improvements).
- Tier 5: usability (UI + admin).
- Tier 6: security & governance before scaling exposure.
- Tier 7–8: autonomy and scheduling.
- Future backlog (IoT, voice, advanced RAG) now lives in `docs/knowledge.md`'s “Future Work” section until specs harden.

## Integration & Governance Notes
- The editable knowledge base (knowledge/app_guide.py) begins as a file-based store in Tier 3 and evolves into a vector-based RAG (knowledge/rag_store.py) by Tier 8.
- The Tier list in this document is the canonical roadmap. Codex must keep it synchronized with the actual repository structure and current development status.
- Every Git commit completing a Tier (or part of one) must include a short update here describing what was implemented, deferred, or changed.

## Development & Validation Rules
**1. End-of-Tier Validation:**
- Each Tier must conclude with a short, focused round of relevant tests—unit, integration, or manual verification—before the Tier is marked completed by the USER.
- Tests should confirm that all functions, flows, and agents defined for that Tier behave as intended.
- Codex should log test outcomes or references (e.g., tests/test_weather.py) where applicable.

**2. Start-of-Tier Confirmation:**
- When beginning a new Tier (or a new task within a Tier), Codex must explicitly confirm the scope with the USER.
- Ask the USER to validate or adjust the planned tasks, files, or goals.
- This prevents duplicated work and ensures any USER-driven modifications to Tier structure are acknowledged before coding begins.

**3. Continuous Synchronization:**
- If scope or architecture changes mid-Tier, Codex should propose corresponding edits to this file (AGENT.md) immediately.
- Never start implementation on a new module or feature without confirming where it fits within the Tier roadmap.

**4. Commenting New Code:**
Every new chunk of functionality—whether a class, function, or file—must include a concise, high-level comment describing:
- Its purpose and relationship to the Tier or agent it belongs to.
- Any dependencies, triggers, or external API calls.
- If it replaces or deprecates existing code, note that explicitly.
This ensures that Codex, the USER, and future contributors can quickly map new code back to its design intent in AGENT.md.
