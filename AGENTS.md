> [!IMPORTANT]
> **Maintenance Rule for Codex**
> This `AGENT.md` file must stay synchronized with the codebase.
> Whenever the App is extended or refactored, Codex should:
> 1. Update the **links and line ranges** in `:codex-file-citation[...]` blocks to match current code.
> 2. Revise existing agent and flow descriptions to reflect any behavioral or architectural changes.
> 3. Add entries for **new agents, tools, or orchestrator modules** as they are introduced.
> 4. Remove or deprecate sections corresponding to deleted functionality.
> Treat this document as the **source of truth for the system’s active agent architecture.**
> Every Tier milestone (1–6) must include a brief update to `AGENT.md`.
> ---------------------------------------------------------------------------------------------

## Overview
This document describes how agents are defined and orchestrated in this repository.
This repo now centers on the Tier-1 orchestration layer under `app/`, `core/`, and
`tools/`. The legacy Rasa project has been archived under `legacy_rasa/` for
reference; it no longer participates in the active runtime.

New agents/tools should continue to prefer the `tools/` + `core/tool_registry.py` path, and
work should remain scoped to the active Tier unless the user explicitly agrees to
pull tasks forward.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=10 path=legacy_rasa/README.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/legacy_rasa/README.md#L1-L10"}​


The Tier-1 CLI assembles an `Orchestrator` with the rule-based `NLUService`, a `ToolRegistry`, the `LLMRouter`, and the Tier-2 `LearningLogger` so every message follows the NLU → Orchestrator → Tool chain and gets persisted for observability.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=39 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L22-L39"}​​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=152 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L32-L152"}​​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=199 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L199"}​

---

## Agent Flow
1. **User request** → handled by `core.orchestrator.Orchestrator.handle_message()` after the CLI captures the text.​:codex-file-citation[codex-file-citation]{line_range_start=41 line_range_end=60 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L41-L60"}​​:codex-file-citation[codex-file-citation]{line_range_start=56 line_range_end=154 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L56-L154"}​
2. **NLU classification** (rule heuristics + entities): `NLUService.parse()` maps obvious intents and extracts city/location, Danish/English phrasing, relative day phrases, clock times, and “news about …” topics so payloads already contain structured context.​:codex-file-citation[codex-file-citation]{line_range_start=65 line_range_end=218 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L65-L218"}​
3. **Router/Orchestrator**:
   - If confidence ≥ threshold → call the registered tool via `ToolRegistry.run_tool()` (today that’s weather/news, with todo/kitchen/calendar requested via router) using the parsed entities.​:codex-file-citation[codex-file-citation]{line_range_start=82 line_range_end=118 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L82-L118"}​​:codex-file-citation[codex-file-citation]{line_range_start=66 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L66-L151"}​​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=36 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L36"}​
   - Else → `LLMRouter.route()` asks OpenAI which tool (weather, news, todo_list, kitchen_tips, calendar_edit) should run; when no tool is selected the orchestrator triggers the general ChatGPT fallback whose answers start with “From ChatGPT.”​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=170 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L94-L170"}​​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L24-L121"}​​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=49 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L21-L49"}​
4. **Tool execution** → weather/news call live APIs while todo/kitchen/calendar tools mutate/read JSON stores under `data_pipeline/`; new `AppGuideStore` changes share the same persistence layer for future RAG upgrades.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=145 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L13-L145"}​​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L45"}​​:codex-file-citation[codex-file-citation]{line_range_start=43 line_range_end=240 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L43-L240"}​​:codex-file-citation[codex-file-citation]{line_range_start=27 line_range_end=148 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L27-L148"}​​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=291 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L32-L291"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​
5. **Response assembly** → tool outputs now cover all five domains and are normalized via the orchestrator formatter map before returning to the user.​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L19-L151"}​​:codex-file-citation[codex-file-citation]{line_range_start=118 line_range_end=145 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L118-L145"}​​:codex-file-citation[codex-file-citation]{line_range_start=28 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L28-L45"}​​:codex-file-citation[codex-file-citation]{line_range_start=211 line_range_end=240 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L211-L240"}​​:codex-file-citation[codex-file-citation]{line_range_start=124 line_range_end=148 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L124-L148"}​​:codex-file-citation[codex-file-citation]{line_range_start=229 line_range_end=259 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L229-L259"}​
6. **Turn logging & review queue** → every handled message produces a `TurnRecord`, low-confidence or fallback cases enqueue a `ReviewItem`, and the orchestrator now annotates log extras with the invoked tool domain/action so Tier‑2 analytics can filter todo/kitchen/calendar events.​:codex-file-citation[codex-file-citation]{line_range_start=138 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L138-L203"}​​:codex-file-citation[codex-file-citation]{line_range_start=70 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L70-L151"}​​:codex-file-citation[codex-file-citation]{line_range_start=142 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L142-L253"}​

---

## Agents
| Agent | Description | Source | Trigger / Intent |
|--------|--------------|--------|------------------|
| **NLU Agent** | Parses user input into intents and extracts city/topic/time entities (English + Danish cues) before confidence-gating. | `core/nlu_service.py` (`NLUService`)​:codex-file-citation[codex-file-citation]{line_range_start=25 line_range_end=201 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L25-L201"}​ | All user inputs |
| **Weather Agent** | Calls Open-Meteo geocoding + hourly/current APIs, honors parsed time hints for future hours, and formats forecast/current summaries. | `tools/weather.py` (`run`, `format_weather_response`)​:codex-file-citation[codex-file-citation]{line_range_start=65 line_range_end=248 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L65-L248"}​ | `intent:ask_weather`​:codex-file-citation[codex-file-citation]{line_range_start=78 line_range_end=118 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L78-L118"}​ |
| **News Agent** | Reuses the shared topic search helper (Google News + NewsAPI) to return current headlines for the requested topic. | `tools/news.py` (`run`, `format_news_list`)​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L45"}​ | `intent:get_news`​:codex-file-citation[codex-file-citation]{line_range_start=78 line_range_end=118 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L78-L118"}​ |
| **Todo Agent** | Maintains JSON-backed todos with CRUD actions, Danish deadline parsing (dd/mm/åååå + month names), countdown metadata, and dual-format responses (friendly text + raw JSON) for quick testing; orchestrator metadata tags these events with `domain=todo`. | `tools/todo_list.py` (`run`, `format_todo_response`)​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=320 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L1-L320"}​​:codex-file-citation[codex-file-citation]{line_range_start=12 line_range_end=66 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L12-L66"}​ | Router-selected `todo_list` tool (no direct NLU intent).​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=49 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L21-L49"}​ |
| **Kitchen Tips Agent** | Provides read-only tip listings/search powered by file-backed entries; each tip can now include an optional `link` for reference and formatters append the raw JSON payload for on-the-fly verification. | `tools/kitchen_tips.py` (`run`, `format_kitchen_tips_response`)​:codex-file-citation[codex-file-citation]{line_range_start=27 line_range_end=169 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L27-L169"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=52 path=tests/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_kitchen_tips_tool.py#L1-L52"}​ | Router-selected `kitchen_tips` tool (LLM intent classification).​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=49 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L21-L49"}​ |
| **Calendar Edit Agent** | Adds, updates, and deletes calendar events with ISO8601 validation, optional `location`/`link` fields, and returns both the human summary and the stored JSON for validation. | `tools/calendar_edit.py` (`run`, `format_calendar_response`)​:codex-file-citation[codex-file-citation]{line_range_start=142 line_range_end=294 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L142-L294"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=64 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L64"}​ | Router-selected `calendar_edit` tool (LLM intent classification).​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=49 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L21-L49"}​ |
| **App Guide Knowledge Agent** | File-backed knowledge sections with ISO timestamps provide lightweight editable context for future RAG upgrades. | `knowledge/app_guide.py` (`AppGuideStore`)​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​ | Admin/automation updates; future router calls once surfaced as a tool.​ |
| **Fallback Agent** | Asks OpenAI which tool should run and, when none apply, produces a prefixed “From ChatGPT” answer for the user. | `core/llm_router.py` (`LLMRouter`)​:codex-file-citation[codex-file-citation]{line_range_start=24 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L24-L121"}​ | Low NLU confidence / router “no tool” decisions.​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L94-L151"}​ |
| **Learning Logger** | Persists `TurnRecord`/`ReviewItem` JSONL rows with configurable redaction (email/phone/credit card/gov ID/URL) and file rotation for analytics and future Tier-4 retraining workflows. | `core/learning_logger.py` (`LearningLogger`, `TurnRecord`, `ReviewItem`)​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​ | All handled turns; review queue populated for low-confidence, fallback, or tool errors.​:codex-file-citation[codex-file-citation]{line_range_start=133 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L133-L203"}​ |

---

## Key Files
| File | Purpose |
|------|----------|
| `app/main.py` | CLI entry point; builds the orchestrator wiring NLU, registry, router, and Tier-2 logger.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=39 path=app/main.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/main.py#L21-L39"}​ |
| `app/config.py` | Defaults for NLU threshold, logging paths (`LOGGING_ENABLED`, `LOG_DIR`, `REVIEW_QUEUE_DIR`), redaction controls (`LOG_REDACTION_ENABLED`, `LOG_REDACTION_PATTERNS`), rotation settings (`LOG_MAX_BYTES`, `LOG_BACKUP_COUNT`), enabled tools, and OpenAI credentials lookup.​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=162 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L162"}​ |
| `core/orchestrator.py` | Coordinates NLU, tool dispatch, logging, and response formatting.​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L32-L203"}​ |
| `core/nlu_service.py` | Lightweight intent detector used before escalating to the LLM.​:codex-file-citation[codex-file-citation]{line_range_start=25 line_range_end=201 path=core/nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/nlu_service.py#L25-L201"}​ |
| `core/llm_router.py` | OpenAI-based fallback router that decides between tools, instructs on missing credentials, and returns direct replies.​:codex-file-citation[codex-file-citation]{line_range_start=15 line_range_end=121 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L15-L121"}​ |
| `core/tool_registry.py` | Registers tool callables and mediates execution/lookup.​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=40 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L40"}​ |
| `core/news_service.py` | Shared NewsAPI / Google News helpers formerly in the Rasa action layer.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=189 path=core/news_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/news_service.py#L1-L189"}​ |
| `core/learning_logger.py` | Dataclass schemas (`TurnRecord`, `ReviewItem`), JSONL writer, configurable redaction, and size-based log rotation used for Tier-2 observability.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​ |
| `tools/weather.py` | Weather tool implementation plus time-aware formatter helpers.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=248 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L13-L248"}​ |
| `tools/news.py` | News tool implementation plus formatter helpers.​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L45"}​ |
| `core/json_storage.py` | Shared Tier-3 helper providing atomic JSON reads/writes for every new tool store.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​ |
| `knowledge/app_guide.py` | File-backed knowledge base with list/get/upsert/delete helpers and ISO timestamps.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​ |
| `tools/todo_list.py` | Todo tool with CRUD operations, formatter helpers, and status normalization.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=276 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L1-L276"}​ |
| `tools/kitchen_tips.py` | Read-only kitchen tips lookups plus formatter utilities for list/get/search actions.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=156 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L1-L156"}​ |
| `tools/calendar_edit.py` | Calendar editing tool with ISO validation, run/update/delete paths, and summary formatter.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=294 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L1-L294"}​ |
| `docs/knowledge.md` | Human-readable knowledge playbook that now mirrors the AppGuide content and lives alongside the JSON-backed knowledge base.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=55 path=docs/knowledge.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/docs/knowledge.md#L1-L55"}​ |
| `tools/__init__.py` | Loads weather, news, todo, kitchen, and calendar tools into the shared registry.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=20 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L1-L20"}​ |
| `tests/` | Pytest suite that must grow alongside new features (`test_learning_logger.py`, `test_news_service.py`, `test_nlu_service.py`, plus Tier‑3 additions for app guide/todo/kitchen/calendar).​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=86 path=tests/test_learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_learning_logger.py#L1-L86"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=61 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L61"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=50 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L1-L50"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=46 path=tests/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_kitchen_tips_tool.py#L1-L46"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=66 path=tests/test_app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_app_guide.py#L1-L66"}​ |

---

### Archived Legacy Rasa Project
The historical Rasa project structure is preserved under `legacy_rasa/` for
reference only. Move those files back to their original locations if you ever
need to resurrect the old stack.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=10 path=legacy_rasa/README.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/legacy_rasa/README.md#L1-L10"}​

---

## Notes
- Confidence threshold for NLU fallback: `0.65` (see `app/config.py`).​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=38 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L38"}​
- The Tier-1 CLI automatically loads `.env` values on import when `python-dotenv` is installed.​:codex-file-citation[codex-file-citation]{line_range_start=8 line_range_end=13 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L8-L13"}​
- Logging defaults: `LOGGING_ENABLED` (on by default), `LOG_DIR` (`logs/turns.jsonl`), and `REVIEW_QUEUE_DIR` (`data_pipeline/nlu_training_bucket/pending.jsonl`) auto-create directories when the logger writes.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=105 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L22-L105"}​​:codex-file-citation[codex-file-citation]{line_range_start=184 line_range_end=195 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L184-L195"}​
- Redaction is enabled by default; tune `LOG_REDACTION_ENABLED` / `LOG_REDACTION_PATTERNS` for raw transcripts or custom scrubbing (emails, phones, credit cards, gov IDs, URLs).​:codex-file-citation[codex-file-citation]{line_range_start=108 line_range_end=135 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L108-L135"}​​:codex-file-citation[codex-file-citation]{line_range_start=211 line_range_end=227 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L211-L227"}​
- `docs/knowledge.md` is part of the Tier‑3 knowledge base; keep its runbook in lock-step with `knowledge/app_guide.py` entries so the human-readable guide matches the JSON exposed to agents.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=55 path=docs/knowledge.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/docs/knowledge.md#L1-L55"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​
- Todo reminders parse Danish-formatted dates (e.g., `1/7/2026`, `1 juli 2026`) from structured fields or free-form text, attach `deadline_days_until`, and order `list` results with closest deadlines first followed by alphabetical leftovers.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=320 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L1-L320"}​​:codex-file-citation[codex-file-citation]{line_range_start=12 line_range_end=66 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L12-L66"}​
- Size-based rotation is governed by `LOG_MAX_BYTES` and `LOG_BACKUP_COUNT`; older segments spill into `.1`, `.2`, etc., before new turns append.​:codex-file-citation[codex-file-citation]{line_range_start=137 line_range_end=162 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L137-L162"}​​:codex-file-citation[codex-file-citation]{line_range_start=229 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L229-L253"}​
- Todo, kitchen, and calendar formatters append the raw JSON payload directly after the friendly sentence so testers can confirm stored data without opening the files.​:codex-file-citation[codex-file-citation]{line_range_start=211 line_range_end=320 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L211-L320"}​​:codex-file-citation[codex-file-citation]{line_range_start=82 line_range_end=156 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L82-L156"}​​:codex-file-citation[codex-file-citation]{line_range_start=229 line_range_end=287 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L229-L287"}​
- Tool agents expose `run(payload)` callables; formatters convert their dict results into strings for replies.​:codex-file-citation[codex-file-citation]{line_range_start=65 line_range_end=145 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L65-L145"}​​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L45"}​
- Tier‑3 todo/kitchen/calendar tools share `core.json_storage` for atomic persistence and store their data under `data_pipeline/*.json`, keeping the formatters deterministic for the router.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​​:codex-file-citation[codex-file-citation]{line_range_start=137 line_range_end=240 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L137-L240"}​​:codex-file-citation[codex-file-citation]{line_range_start=82 line_range_end=148 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L82-L148"}​​:codex-file-citation[codex-file-citation]{line_range_start=142 line_range_end=259 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L142-L259"}​
- Weather tool respects parsed time hints by selecting the closest hourly forecast when available and otherwise returning current conditions with a note.​:codex-file-citation[codex-file-citation]{line_range_start=65 line_range_end=145 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L65-L145"}​
- News tool now calls the shared `core.news_service` helpers (Google News + NewsAPI) for live headlines.​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=45 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L45"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=189 path=core/news_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/news_service.py#L1-L189"}​
- When the router cannot pick a tool, the general ChatGPT fallback answers the user and prefixes responses with “From ChatGPT.”​:codex-file-citation[codex-file-citation]{line_range_start=121 line_range_end=151 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L121-L151"}​​:codex-file-citation[codex-file-citation]{line_range_start=79 line_range_end=92 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L79-L92"}​
- LLM fallback uses the OpenAI Python v1 client (`chat.completions`) and, when credentials are missing, returns guidance for setting `OPENAI_API_KEY` before retrying.​:codex-file-citation[codex-file-citation]{line_range_start=58 line_range_end=92 path=core/llm_router.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/llm_router.py#L58-L92"}​​:codex-file-citation[codex-file-citation]{line_range_start=8 line_range_end=54 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L8-L54"}​
- Each new Tier deliverable must include pytest coverage and the command/output should be surfaced in status updates so reviewers see the prompts/results.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=40 path=tests/test_news_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_news_service.py#L1-L40"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=30 path=tests/test_nlu_service.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_nlu_service.py#L1-L30"}​
- Tier progression is linear: do not start higher-tier features without explicit user approval to pull them forward.​:codex-file-citation[codex-file-citation]{line_range_start=94 line_range_end=115 path=AGENTS.md git_url="https://github.com/cbmluca/rasa-llm/blob/main/AGENTS.md#L94-L115"}​
- Future agents can be added by:
  1. Creating a new tool module under `/tools/` that implements a `run(payload)` callable.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=116 path=tools/weather.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/weather.py#L13-L116"}​​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=25 path=tools/news.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/news.py#L11-L25"}​
  2. Registering it via `load_all_core_tools()` or analogous registry wiring in `tools/__init__.py`.​:codex-file-citation[codex-file-citation]{line_range_start=13 line_range_end=16 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L13-L16"}​​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=36 path=core/tool_registry.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/tool_registry.py#L18-L36"}​
  3. Updating orchestrator or router configuration (e.g., enabling the tool name in `app/config.py`) and reflecting it in this Agents table.​:codex-file-citation[codex-file-citation]{line_range_start=18 line_range_end=38 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L18-L38"}​​:codex-file-citation[codex-file-citation]{line_range_start=35 line_range_end=65 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L35-L65"}​

---

## Example
```python
# Example: News & Weather Agent Registration
from core.tool_registry import ToolRegistry
from tools import load_all_core_tools
from core.llm_router import LLMRouter

registry = ToolRegistry()
load_all_core_tools(registry)

AGENTS = {
    "news": registry.available_tools()["news"],
    "weather": registry.available_tools()["weather"],
    "fallback": LLMRouter(model="gpt-4o-mini", api_key="...", enabled_tools=("weather", "news")),
}
```

---

## Development Roadmap (Tier Plan)
Each Tier represents a functional milestone in the system’s evolution.
Codex must keep this section synchronized with the repository state.
Whenever a Tier is completed or partially implemented, update this table and associated code citations.

| Tier  | Title                                                   | Purpose                                                                    | Core Files / Modules                                                                                                                             | Key Additions                                                                                          |
| ----- | ------------------------------------------------------- | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------ |
| **1** | **Core Runtime + 2 Tools (Baseline)**                   | Establish CLI orchestrator pipeline (NLU → LLM → Tool) with weather/news.  | `app/main.py`, `core/orchestrator.py`, `core/nlu_service.py`, `core/llm_router.py`, `core/tool_registry.py`, `tools/weather.py`, `tools/news.py` | Working message loop, formatted responses.                                                             |
| **2** | **Logging & Observability**                             | Add minimal analytics and failure visibility before scaling tools.         | `core/learning_logger.py`, `core/orchestrator.py`, `app/config.py`, `tests/test_learning_logger.py`                                              | `LearningLogger` now captures every turn + review queue entries, redacts emails/phones/cards/IDs/URLs by default, rotates log files with size caps, and ships with config toggles/env overrides plus pytest coverage validating JSONL output, rotation, and review triggers.​:codex-file-citation[codex-file-citation]{line_range_start=21 line_range_end=253 path=core/learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/learning_logger.py#L21-L253"}​​:codex-file-citation[codex-file-citation]{line_range_start=56 line_range_end=203 path=core/orchestrator.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/orchestrator.py#L56-L203"}​​:codex-file-citation[codex-file-citation]{line_range_start=19 line_range_end=162 path=app/config.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/app/config.py#L19-L162"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=164 path=tests/test_learning_logger.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_learning_logger.py#L1-L164"}​ |
| **3** | **Tool Expansion + Editable Knowledge Base (RAG Seed)** | Broaden functionality and introduce persistent, editable data.             | `tools/todo_list.py`, `tools/kitchen_tips.py`, `tools/calendar_edit.py`, `knowledge/app_guide.py`, `core/json_storage.py`, `tools/__init__.py`, Tier‑3 pytest modules | JSON-backed todo/kitchen/calendar tools with shared atomic storage + formatter outputs, editable `AppGuideStore`, router/config updates to expose the new tool names, and pytest coverage for every store.​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=294 path=tools/calendar_edit.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/calendar_edit.py#L1-L294"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=276 path=tools/todo_list.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/todo_list.py#L1-L276"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=156 path=tools/kitchen_tips.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/kitchen_tips.py#L1-L156"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=140 path=knowledge/app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/knowledge/app_guide.py#L1-L140"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=41 path=core/json_storage.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/core/json_storage.py#L1-L41"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=20 path=tools/__init__.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tools/__init__.py#L1-L20"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=61 path=tests/test_calendar_edit_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_calendar_edit_tool.py#L1-L61"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=50 path=tests/test_todo_list_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_todo_list_tool.py#L1-L50"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=46 path=tests/test_kitchen_tips_tool.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_kitchen_tips_tool.py#L1-L46"}​​:codex-file-citation[codex-file-citation]{line_range_start=1 line_range_end=66 path=tests/test_app_guide.py git_url="https://github.com/cbmluca/rasa-llm/blob/main/tests/test_app_guide.py#L1-L66"}​ |
| **4** | **Self-Evolving Logic**                                 | Use logs and admin scripts to retrain or extend NLU automatically.         | `core/learning_logger.py`, `app/admin_scripts.py`                                                                                                | CLI scripts for reviewing failed intents, adding examples, proposing new tools.                        |
| **5** | **Web UI / Admin Panel**                                | Introduce browser interface for chat and manual data editing.              | `ui/web_app.py`, `ui/channel_api.py`                                                                                                             | Chat interface, admin pages for viewing logs, editing todos/kitchen tips/app guide.                    |
| **6** | **Infrastructure / Always-On Execution**                | Enable persistent runtime and scheduled background tasks.                  | `app/main.py` (scheduler hooks), deployment configs                                                                                              | Cron/APScheduler or equivalent for continuous operation.                                               |
| **7** | **Scheduler & Agent Actions (Advanced Calendar)**       | Allow delayed or autonomous actions such as reminders and pseudo-bookings. | `core/scheduler.py`, `tools/calendar_edit.py` (extended), `data_pipeline/calendar_tasks.json`                                                    | Handle time-based triggers: “book badminton Thursday,” “doctor check-up window.”                       |
| **8** | **Future / Backlog: IoT, Voice, Advanced RAG**          | Expand modalities and self-documentation.                                  | `tools/tts.py`, `tools/voice_recognition.py`, `integrations/iot_home.py`, `knowledge/rag_store.py`                                               | Text-to-speech, speech-to-text, smart-home integration, vector-based RAG that updates from logs.       |

**Evolution Summary**
- Tiers 1–2: foundation and visibility.
- Tier 3: breadth (more tools + editable data).
- Tier 4: self-learning (turn logs → improvements).
- Tier 5: usability (UI + admin).
- Tier 6–7: autonomy (background & scheduling).
- Tier 8: ecosystem expansion (IoT, multimodal, advanced RAG).

## Integration & Governance Notes
- The editable knowledge base (knowledge/app_guide.py) begins as a file-based store in Tier 3 and evolves into a vector-based RAG (knowledge/rag_store.py) by Tier 8.
- The Tier list in this document is the canonical roadmap. Codex must keep it synchronized with the actual repository structure and current development status.
- Every Git commit completing a Tier (or part of one) must include a short update here describing what was implemented, deferred, or changed.

## Development & Validation Rules
**1. End-of-Tier Validation:**
- Each Tier must conclude with a short, focused round of relevant tests—unit, integration, or manual verification—before the Tier is marked completed by the USER.
- Tests should confirm that all functions, flows, and agents defined for that Tier behave as intended.
- Codex should log test outcomes or references (e.g., tests/test_weather.py) where applicable.

**2. Start-of-Tier Confirmation:**
- When beginning a new Tier (or a new task within a Tier), Codex must explicitly confirm the scope with the USER.
- Ask the USER to validate or adjust the planned tasks, files, or goals.
- This prevents duplicated work and ensures any USER-driven modifications to Tier structure are acknowledged before coding begins.

**3. Continuous Synchronization:**
- If scope or architecture changes mid-Tier, Codex should propose corresponding edits to this file (AGENT.md) immediately.
- Never start implementation on a new module or feature without confirming where it fits within the Tier roadmap.

**4. Commenting New Code:**
Every new chunk of functionality—whether a class, function, or file—must include a concise, high-level comment describing:
- Its purpose and relationship to the Tier or agent it belongs to.
- Any dependencies, triggers, or external API calls.
- If it replaces or deprecates existing code, note that explicitly.
This ensures that Codex, the USER, and future contributors can quickly map new code back to its design intent in AGENT.md.
